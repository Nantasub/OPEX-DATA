<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>โปรแกรมบันทึกข้อมูล PR/GR (GitHub Pages)</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SheetJS (xlsx) for Excel Export -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>
    <!-- Google Fonts: Sarabun & Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Sarabun:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Sarabun', 'Inter', sans-serif;
        }
        input::-webkit-calendar-picker-indicator { opacity: 0.8; cursor: pointer; }
        fieldset:disabled { opacity: 0.5; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
    </style>
</head>
<body class="bg-gray-50">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <div class="w-full bg-white p-6 sm:p-8 rounded-xl shadow-lg">
            <header class="mb-8 text-center">
                <h1 class="text-3xl sm:text-4xl font-bold text-gray-800">โปรแกรมบันทึกข้อมูล PR/GR</h1>
                <p class="text-gray-500 mt-2">ขับเคลื่อนโดย Firebase Firestore</p>
            </header>

            <!-- Data Entry Form -->
            <form id="data-form" class="mb-8 border-t pt-6">
                 <fieldset id="data-fieldset" disabled>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-6 gap-y-4">
                        <!-- Form columns -->
                        <div class="space-y-4">
                            <div><label class="block text-sm font-medium text-gray-700">วันที่บันทึกข้อมูล</label><input type="text" id="recordingDate" class="mt-1 w-full p-2 bg-gray-100 border border-gray-300 rounded-lg" readonly></div>
                            <div><label for="prNumber" class="block text-sm font-medium text-gray-700">เลขที่ PR <span class="text-red-500">*</span></label><input type="text" id="prNumber" class="mt-1 w-full p-2 border border-gray-300 rounded-lg" required></div>
                            <div><label for="grDate" class="block text-sm font-medium text-gray-700">วันที่ GR</label><input type="date" id="grDate" class="mt-1 w-full p-2 border border-gray-300 rounded-lg"></div>
                            <div><label for="ivNumber" class="block text-sm font-medium text-gray-700">เลขที่ IV (ถ้ามี)</label><input type="text" id="ivNumber" class="mt-1 w-full p-2 border border-gray-300 rounded-lg"></div>
                        </div>
                        <div class="space-y-4">
                            <div><label for="vendor" class="block text-sm font-medium text-gray-700">Vendor <span class="text-red-500">*</span></label><input list="vendor-list" id="vendor" class="mt-1 w-full p-2 border border-gray-300 rounded-lg" required><datalist id="vendor-list"></datalist></div>
                            <div><label for="item" class="block text-sm font-medium text-gray-700">รายการ <span class="text-red-500">*</span></label><input type="text" id="item" class="mt-1 w-full p-2 border border-gray-300 rounded-lg" required></div>
                            <div><label for="unitPrice" class="block text-sm font-medium text-gray-700">ราคาต่อหน่วย (Inc. VAT) <span class="text-red-500">*</span></label><input type="number" id="unitPrice" step="0.01" class="mt-1 w-full p-2 border border-gray-300 rounded-lg" required></div>
                            <div><label for="quantity" class="block text-sm font-medium text-gray-700">จำนวน <span class="text-red-500">*</span></label><input type="number" id="quantity" step="1" class="mt-1 w-full p-2 border border-gray-300 rounded-lg" required></div>
                            <div><label class="block text-sm font-medium text-gray-700">ราคารวม (Inc. VAT)</label><input type="text" id="totalPrice" class="mt-1 w-full p-2 bg-gray-100 border border-gray-300 rounded-lg" readonly></div>
                        </div>
                        <div class="space-y-4">
                            <div><label for="type" class="block text-sm font-medium text-gray-700">Type <span class="text-red-500">*</span></label><select id="type" class="mt-1 w-full p-2 border border-gray-300 rounded-lg" required><option value="">-- กรุณาเลือก --</option><option value="อะไหล่ Stock">อะไหล่ Stock</option><option value="อะไหล่นอก Stock">อะไหล่นอก Stock</option><option value="งานรับเหมาซ่อมระบบวิศวกรรม">งานรับเหมาซ่อมระบบวิศวกรรม</option><option value="งานรับเหมาซ่อมระบบอาคาร">งานรับเหมาซ่อมระบบอาคาร</option><option value="งานรับเหมาซ่อมงานตกแต่งภายใน">งานรับเหมาซ่อมงานตกแต่งภายใน</option><option value="งานสัญญา PM">งานสัญญา PM</option></select></div>
                            <div><label for="subType" class="block text-sm font-medium text-gray-700">Sub Type</label><input list="subType-list" id="subType" class="mt-1 w-full p-2 border border-gray-300 rounded-lg" disabled><datalist id="subType-list"></datalist></div>
                            <div><label for="poNumber" class="block text-sm font-medium text-gray-700">PO Number</label><input type="text" id="poNumber" class="mt-1 w-full p-2 border border-gray-300 rounded-lg"></div>
                            <div><label for="grTe" class="block text-sm font-medium text-gray-700">GR/TE</label><select id="grTe" class="mt-1 w-full p-2 border border-gray-300 rounded-lg"><option value="GR">GR</option><option value="TE">TE</option></select></div>
                            <div><label for="grNumber" class="block text-sm font-medium text-gray-700">GR Number</label><input type="text" id="grNumber" class="mt-1 w-full p-2 border border-gray-300 rounded-lg"></div>
                        </div>
                    </div>
                </fieldset>
                <div class="mt-6 text-center">
                    <button type="submit" id="submit-btn" class="w-full md:w-auto bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-all duration-300 shadow-md" disabled>บันทึกข้อมูล</button>
                    <p id="form-error" class="text-red-500 text-sm mt-2 h-4"></p>
                </div>
            </form>

            <!-- Data Display Table -->
            <div class="border-t pt-6">
                <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                    <h2 class="text-2xl font-bold text-gray-800">ข้อมูลที่บันทึกไว้</h2>
                    <button id="export-excel-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-4 focus:ring-green-300 transition-all duration-300 shadow-sm flex items-center space-x-2 w-full md:w-auto justify-center" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.884 6.68a.5.5 0 1 0-.768.64L7.349 10l-2.233 2.68a.5.5 0 0 0 .768.64L8 10.781l2.116 2.54a.5.5 0 0 0 .768-.64L8.651 10l2.233-2.68a.5.5 0 0 0-.768-.64L8 9.219l-2.116-2.54z"/><path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5v2z"/></svg>
                        <span>Export เป็น Excel</span>
                    </button>
                </div>
                <div class="overflow-x-auto border border-gray-200 rounded-lg">
                    <table class="min-w-full divide-y divide-gray-200 text-sm">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left font-bold text-gray-600 uppercase">วันที่บันทึก</th><th class="px-4 py-3 text-left font-bold text-gray-600 uppercase">PR No.</th><th class="px-4 py-3 text-left font-bold text-gray-600 uppercase">Vendor</th><th class="px-4 py-3 text-left font-bold text-gray-600 uppercase">รายการ</th><th class="px-4 py-3 text-left font-bold text-gray-600 uppercase">ราคารวม</th><th class="px-4 py-3 text-left font-bold text-gray-600 uppercase">Type</th><th class="px-4 py-3 text-left font-bold text-gray-600 uppercase">Sub Type</th><th class="px-4 py-3 text-left font-bold text-gray-600 uppercase">PO No.</th><th class="px-4 py-3 text-left font-bold text-gray-600 uppercase">Action</th>
                            </tr>
                        </thead>
                        <tbody id="data-table-body" class="bg-white divide-y divide-gray-200">
                             <tr><td colspan="9" class="text-center p-4 text-gray-500">กำลังเชื่อมต่อ...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal for Deletion Confirmation -->
    <div id="delete-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">ยืนยันการลบ</h3>
                <div class="mt-2 px-7 py-3"><p class="text-sm text-gray-500">คุณแน่ใจหรือไม่ว่าต้องการลบรายการนี้?</p></div>
                <div class="items-center px-4 py-3">
                    <button id="modal-confirm-delete" class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-red-700">ยืนยัน</button>
                    <button id="modal-cancel-delete" class="px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-auto ml-2 shadow-sm hover:bg-gray-300">ยกเลิก</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, serverTimestamp, doc, deleteDoc, getDocs, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuration ---
        const firebaseConfig = {
          apiKey: "AIzaSyAs5P_1K4ooS67wrGbsThKqaXBCg0YJvtY",
          authDomain: "opex-web-ca626.firebaseapp.com",
          projectId: "opex-web-ca626",
          storageBucket: "opex-web-ca626.appspot.com",
          messagingSenderId: "119474783032",
          appId: "1:119474783032:web:7e642df12b62ca882ab7cd",
          measurementId: "G-L9NWD7DEB7"
        };
        
        // --- Firebase Initialization ---
        let db;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            document.getElementById('data-fieldset').disabled = false;
            document.getElementById('submit-btn').disabled = false;
        } catch (error) {
            console.error("Firebase Initialization Error:", error);
            document.getElementById('form-error').textContent = "Firebase config is invalid.";
        }

        // --- Global State ---
        let unsubscribeItems = null;
        let currentDataForExport = [];
        const subTypeMap = {
            'อะไหล่ Stock': { collectionName: 'public_subtypes_stock', isExtensible: true, options: ['สุขภัณฑ์', 'ระบบน้ำดี', 'ระบบสื่อสาร', 'ระบบไฟฟ้า'] },
            'อะไหล่นอก Stock': { collectionName: 'public_subtypes_nonstock', isExtensible: true, options: ['สุขภัณฑ์', 'ระบบน้ำดี', 'ระบบสื่อสาร', 'ระบบไฟฟ้า'] },
            'งานรับเหมาซ่อมระบบวิศวกรรม': { collectionName: 'public_subtypes_engineering', isExtensible: true, options: ['ระบบไฟฟ้า', 'ระบบสุขาภิบาล', 'ระบบสื่อสาร', 'ระบบ CCTV'] },
            'งานรับเหมาซ่อมระบบอาคาร': { isExtensible: false, options: [] },
            'งานรับเหมาซ่อมงานตกแต่งภายใน': { isExtensible: false, options: [] },
            'งานสัญญา PM': { isExtensible: false, options: ['Chiller', 'Generator', 'Firepump', 'Elevator&Escalator', 'Clean Room', 'UPS', 'Transformer', 'MDB', 'Fire Safety', 'Pneumatic Tube'] }
        };

        // --- UI Elements ---
        const form = document.getElementById('data-form');
        const formError = document.getElementById('form-error');
        const unitPriceInput = document.getElementById('unitPrice');
        const quantityInput = document.getElementById('quantity');
        const totalPriceInput = document.getElementById('totalPrice');
        const typeSelect = document.getElementById('type');
        const subTypeInput = document.getElementById('subType');
        const subTypeDatalist = document.getElementById('subType-list');
        const vendorInput = document.getElementById('vendor');
        const vendorDatalist = document.getElementById('vendor-list');
        const exportBtn = document.getElementById('export-excel-btn');
        const deleteModal = document.getElementById('delete-modal');
        const confirmDeleteBtn = document.getElementById('modal-confirm-delete');
        const cancelDeleteBtn = document.getElementById('modal-cancel-delete');
        let itemToDelete = null;

        // --- Functions ---
        
        async function populateDatalist(collectionName, datalistElement, defaultOptions = []) {
            try {
                const collectionRef = collection(db, collectionName);
                const snapshot = await getDocs(collectionRef);
                const items = new Set(defaultOptions);
                snapshot.forEach(doc => items.add(doc.data().name));
                datalistElement.innerHTML = '';
                Array.from(items).sort().forEach(item => {
                    const option = document.createElement('option');
                    option.value = item;
                    datalistElement.appendChild(option);
                });
            } catch (error) {
                console.error(`Error populating ${collectionName}:`, error);
            }
        }
        
        async function addUniqueItemToCollection(collectionName, itemName) {
            if (!itemName) return;
            try {
                const docRef = doc(db, collectionName, itemName);
                await setDoc(docRef, { name: itemName });
                console.log(`Upserted "${itemName}" in ${collectionName}`);
            } catch (error) {
                console.error(`Error upserting item to ${collectionName}:`, error);
            }
        }
        
        function updateSubTypeOptions() {
            const selectedType = typeSelect.value;
            const config = subTypeMap[selectedType];
            subTypeInput.value = '';
            subTypeDatalist.innerHTML = '';
            if (config && config.options.length > 0) {
                subTypeInput.disabled = false;
                config.options.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt;
                    subTypeDatalist.appendChild(option);
                });
                if (config.isExtensible && config.collectionName) {
                    populateDatalist(config.collectionName, subTypeDatalist, config.options);
                }
            } else {
                subTypeInput.disabled = true;
            }
        }
        
        function calculateTotalPrice() {
            const unitPrice = parseFloat(unitPriceInput.value) || 0;
            const quantity = parseInt(quantityInput.value) || 0;
            totalPriceInput.value = (unitPrice * quantity).toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function listenForDataChanges() {
            if (unsubscribeItems) unsubscribeItems(); 
            const itemsCollectionRef = collection(db, 'public_items');
            const q = query(itemsCollectionRef);
            
            document.getElementById('data-table-body').innerHTML = '<tr><td colspan="9" class="text-center p-4 text-gray-500">กำลังโหลดข้อมูล...</td></tr>';

            unsubscribeItems = onSnapshot(q, (snapshot) => {
                const tableBody = document.getElementById('data-table-body');
                tableBody.innerHTML = '';
                const dataForExport = [];
                if (snapshot.empty) {
                    tableBody.innerHTML = '<tr><td colspan="9" class="text-center p-4 text-gray-500">ยังไม่มีข้อมูล...</td></tr>';
                    currentDataForExport = [];
                    exportBtn.disabled = true;
                    return;
                }
                
                exportBtn.disabled = false;
                const docs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                docs.sort((a, b) => (b.recordingDate?.toDate?.() || 0) - (a.recordingDate?.toDate?.() || 0));

                docs.forEach(data => {
                    const docId = data.id;
                    const recordingDate = data.recordingDate?.toDate ? data.recordingDate.toDate().toLocaleDateString('th-TH') : 'N/A';
                    const grDate = data.grDate ? new Date(data.grDate).toLocaleDateString('th-TH') : '';
                    const totalPrice = (data.totalPrice || 0).toLocaleString('th-TH', { style: 'currency', currency: 'THB' });
                    
                    const row = tableBody.insertRow();
                    row.innerHTML = `<td class="px-4 py-3 whitespace-nowrap">${recordingDate}</td><td class="px-4 py-3 whitespace-nowrap">${data.prNumber || ''}</td><td class="px-4 py-3 whitespace-nowrap">${data.vendor || ''}</td><td class="px-4 py-3 whitespace-nowrap">${data.item || ''}</td><td class="px-4 py-3 whitespace-nowrap text-right">${totalPrice}</td><td class="px-4 py-3 whitespace-nowrap">${data.type || ''}</td><td class="px-4 py-3 whitespace-nowrap">${data.subType || ''}</td><td class="px-4 py-3 whitespace-nowrap">${data.poNumber || ''}</td><td class="px-4 py-3 whitespace-nowrap"><button class="text-red-600 hover:text-red-900 delete-btn" data-id="${docId}">ลบ</button></td>`;

                    dataForExport.push({
                        'วันที่บันทึก': recordingDate, 'เลขที่ PR': data.prNumber, 'วันที่ GR': grDate, 'เลขที่ IV': data.ivNumber, 'Vendor': data.vendor, 'รายการ': data.item, 'ราคาต่อหน่วย (Inc. VAT)': data.unitPrice, 'จำนวน': data.quantity, 'ราคารวม (Inc. VAT)': data.totalPrice, 'Type': data.type, 'Sub Type': data.subType, 'PO Number': data.poNumber, 'GR/TE': data.grTe, 'GR Number': data.grNumber
                    });
                });
                
                currentDataForExport = dataForExport;
                document.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', () => showDeleteModal(btn.dataset.id)));
            }, (error) => {
                console.error("Error getting documents:", error);
                document.getElementById('data-table-body').innerHTML = `<tr><td colspan="9" class="text-center p-4 text-red-500">เกิดข้อผิดพลาด: ${error.message}</td></tr>`;
            });
        }
        
        function showDeleteModal(id) { itemToDelete = id; deleteModal.classList.remove('hidden'); }
        function hideDeleteModal() { itemToDelete = null; deleteModal.classList.add('hidden'); }

        async function handleDeleteConfirm() {
            if (itemToDelete) {
                try {
                    const docRef = doc(db, 'public_items', itemToDelete);
                    await deleteDoc(docRef);
                } catch (error) {
                    console.error("Error deleting document: ", error);
                } finally {
                    hideDeleteModal();
                }
            }
        }
        
        function exportToExcel() {
            if (currentDataForExport.length === 0) {
                formError.textContent = 'ไม่มีข้อมูลสำหรับ Export';
                setTimeout(() => formError.textContent = '', 3000);
                return;
            }
            try {
                const ws = XLSX.utils.json_to_sheet(currentDataForExport);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Data Export");
                XLSX.writeFile(wb, "pr_gr_export.xlsx");
            } catch (error) {
                console.error("Export to Excel failed:", error);
                formError.textContent = 'เกิดข้อผิดพลาดในการ Export Excel';
            }
        }

        // --- Event Listeners & Initializers ---
        if (db) {
            unitPriceInput.addEventListener('input', calculateTotalPrice);
            quantityInput.addEventListener('input', calculateTotalPrice);
            typeSelect.addEventListener('change', updateSubTypeOptions);
            exportBtn.addEventListener('click', exportToExcel);
            confirmDeleteBtn.addEventListener('click', handleDeleteConfirm);
            cancelDeleteBtn.addEventListener('click', hideDeleteModal);

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                formError.textContent = '';
                const formData = {
                    recordingDate: serverTimestamp(), prNumber: document.getElementById('prNumber').value.trim(), grDate: document.getElementById('grDate').value, ivNumber: document.getElementById('ivNumber').value.trim(), vendor: vendorInput.value.trim(), item: document.getElementById('item').value.trim(), unitPrice: parseFloat(unitPriceInput.value) || 0, quantity: parseInt(quantityInput.value) || 0, totalPrice: (parseFloat(unitPriceInput.value) || 0) * (parseInt(quantityInput.value) || 0), type: typeSelect.value, subType: subTypeInput.disabled ? '' : subTypeInput.value.trim(), poNumber: document.getElementById('poNumber').value.trim(), grTe: document.getElementById('grTe').value, grNumber: document.getElementById('grNumber').value.trim()
                };
                if (!formData.prNumber || !formData.vendor || !formData.item || !formData.unitPrice || !formData.quantity || !formData.type) {
                    formError.textContent = 'กรุณากรอกข้อมูลในช่องที่มีเครื่องหมาย * ให้ครบถ้วน';
                    return;
                }
                try {
                    await addDoc(collection(db, 'public_items'), formData);
                    await addUniqueItemToCollection('public_vendors', formData.vendor);
                    const subTypeConfig = subTypeMap[formData.type];
                    if (subTypeConfig && subTypeConfig.isExtensible && formData.subType) {
                        await addUniqueItemToCollection(subTypeConfig.collectionName, formData.subType);
                    }
                    form.reset();
                    totalPriceInput.value = '';
                    document.getElementById('recordingDate').value = new Date().toLocaleDateString('th-TH');
                    updateSubTypeOptions();
                } catch (error) {
                    console.error("Error writing document:", error);
                    formError.textContent = 'เกิดข้อผิดพลาดในการบันทึกข้อมูล';
                }
            });

            // Initial Load
            listenForDataChanges();
            populateDatalist('public_vendors', vendorDatalist); 
            document.getElementById('recordingDate').value = new Date().toLocaleDateString('th-TH');
            updateSubTypeOptions();
        }
    </script>
</body>
</html>
